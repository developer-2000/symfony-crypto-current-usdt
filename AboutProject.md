# О проекте: API оценки стоимости криптопортфеля

Краткое описание реализованной функциональности для проверки тестового задания.

---

## Что сделано по ТЗ

- **Расчёт портфеля по расписанию** — каждый час (интервал настраивается через `CRON_SNAPSHOT_MINUTES` в `.env`) выполняется расчёт общей стоимости портфеля в USDT по формулам из ТЗ (BTC×цена + ETH×цена + SOL×цена + USDT). Источник цен — Binance API (avgPrice).

- **Сохранение истории** — результаты сохраняются в БД в таблицу `portfolio_snapshot` (поля: `id`, `calculated_at`, `amount_usdt`). Один снапшот на час (UTC), при повторном запуске за тот же час — идемпотентное поведение без ошибки.

- **API для графика** — `GET /api/portfolio/history` с параметрами `?hours=N` или `?minutes=N`. Ответ — JSON-массив вида `[{"time": "...", "amount_usdt": ...}]`, отсортированный по времени по возрастанию (ASC). Лимиты и значения по умолчанию задаются в конфиге и `.env`.

- **BinancePriceService** — отдельный сервис с HTTP-клиентом, параллельными запросами к Binance, обработкой ошибок API и логированием. Интерфейс + реализация, исключение `BinanceApiException` при сбоях.

- **PortfolioValuationService** — сервис расчёта: получает цены через BinancePriceService, считает total_usdt, округляет до 8 знаков, сохраняет снапшот в БД. Возвращает данные снапшота при успехе (для Mercure).

- **Консольная команда** — `app:portfolio:snapshot`. Вызывается cron’ом; при успехе — лог и success, при ошибке Binance/исключении — error в лог и ненулевой код возврата.

- **Логирование** — Monolog; дополнительно `LogManager` для динамических логгеров (файл/БД). События снапшота (успех/ошибка) пишутся в канал `events` в таблицу `app_log` для отображения в веб-интерфейсе.

- **Конфигурация** — состав портфеля, URL Binance, символы, лимиты API и т.д. задаются только в `.env`; в `config/` — только подстановка через `%env(...)%`.

- **Cron** — реализован внутри контейнера (пакет cron, entrypoint создаёт расписание). Интервал задаётся переменной `CRON_SNAPSHOT_MINUTES`. Для ручной проверки можно вызвать команду из контейнера.

- **Тесты** — юнит-тесты для BinancePriceService и PortfolioValuationService (успех, ошибки API, идемпотентность). Запуск: `php vendor/bin/simple-phpunit`.

---

## Дополнительно к ТЗ

- **Веб-дашборд** — главная страница (http://localhost:8080): текущая стоимость портфеля, изменение за период в %, переключатель периодов 24ч / 7д / 30д, интерактивный график (Chart.js) по данным API. Состояния: загрузка, пусто, ошибка. Адаптивная вёрстка, тёмная/светлая тема (CSS-переменные).

- **Mercure (push)** — при появлении нового снапшота бэкенд публикует событие в топик `portfolio/snapshots`. Фронт подписан через EventSource; при получении события — toast «Новые данные по портфелю» и автоматическое обновление графика и карточек без перезагрузки.

- **Value log (история по периоду)** — блок под карточками: список «время + сумма USDT» по выбранному периоду. Данные из того же `GET /api/portfolio/history`, что и график.

- **API breakdown** — `GET /api/portfolio/breakdown`: текущая разбивка портфеля по активам (количество, цена, стоимость в USDT). Логика в `PortfolioBreakdownService`, при ошибке Binance — 503.

- **Валидация API в стиле Form Request** — DTO `PortfolioHistoryRequest` с правилами и сообщениями; `FormRequestValueResolver` валидирует до входа в контроллер. 
- При ошибке — 422 с JSON `{"error": "..."}`.

- **Единый лог ошибок** — для логгера по умолчанию ошибки дополнительно пишутся в `var/log/errors.log`.

---

## Стек и структура

- **Symfony 7.4**, PHP 8.2+, Doctrine ORM, миграции в `migrations/`.
- **Docker**: dev-compose (app: nginx + PHP-FPM, MySQL, Mercure, phpMyAdmin). Старт: `docker compose -f dev-compose.yml up -d`.
- **Маршруты**: веб — `src/Controller/Web/`, API — `src/Controller/Api/` с префиксом `/api`.
- Документация и актуальный план — в **main-task.md** (спецификация и журнал изменений).

---

Файл составлен для быстрой проверки соответствия заданию и обзора реализованных возможностей.
