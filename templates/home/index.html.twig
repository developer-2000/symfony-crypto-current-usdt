{% extends 'base.html.twig' %}

{% block title %}Portfolio dashboard — value in USDT{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
    .header-right{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;}
    .mercure-status{font-size:1.125rem;font-weight:600;color:var(--text-muted,#8b9cb3);}
    .mercure-status__state--on{color:var(--accent,#3fb950);}
    .mercure-status__state--off{color:var(--negative,#f85149);}
    </style>
{% endblock %}

{% block body %}
<div class="page">
    <header class="page-header">
        <h1><a href="{{ path('app_home') }}">Portfolio USDT</a></h1>
        <div class="header-right">
            <div id="mercure-status" class="mercure-status" aria-live="polite" title="Mercure subscription status">Mercure (<span id="mercure-state" class="mercure-status__state mercure-status__state--off">—</span>)</div>
            <div class="period-selector" role="tablist" aria-label="Chart period">
                <button type="button" class="active" data-minutes="10" role="tab" aria-selected="true">10 min</button>
                <button type="button" data-hours="1" role="tab" aria-selected="false">1 h</button>
                <button type="button" data-hours="24" role="tab" aria-selected="false">24 h</button>
            </div>
        </div>
    </header>

    <main>
        <p class="formula-line">total_usdt = BTC_amount×BTC_price + ETH_amount×ETH_price + SOL_amount×SOL_price + USDT_amount</p>

        <div class="dashboard-row">
            <div class="cards-col">
                <div class="cards">
                    <div class="card" id="card-last">
                        <div class="card__label">Current value</div>
                        <div class="card__value" id="value-last">—</div>
                    </div>
                    <div class="card" id="card-change">
                        <div class="card__label">Change over period</div>
                        <div class="card__value" id="value-change">—</div>
                    </div>
                </div>
            </div>
            <section class="events-section" aria-label="Value log">
                <div class="events-section__head">
                    <h2 class="events-section__title">Value log</h2>
                    <h3 class="history-block__title">History for <span id="history-period-label">10 min</span></h3>
                </div>
                <div id="history-block" class="history-block hidden">
                    <ul id="history-list" class="history-list"></ul>
                </div>
            </section>
        </div>

        <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

        <div class="chart-wrap" id="chart-wrap">
            <div id="chart-state-loading" class="state-message">Loading…</div>
            <div id="chart-state-empty" class="state-message hidden">No data for the selected period.</div>
            <div id="chart-state-error" class="state-message error hidden"></div>
            <div id="chart-container" class="hidden" style="position: relative; height: 320px;">
                <canvas id="portfolio-chart" aria-label="Portfolio value chart over time"></canvas>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
(function () {
    const API_URL = '{{ path('api_portfolio_history_index') }}';
    const MERCURE_SUBSCRIBE_URL = {{ mercure(['portfolio/snapshots'], { subscribe: ['portfolio/snapshots'] })|json_encode|raw }};
    const cards = { last: document.getElementById('value-last'), change: document.getElementById('value-change') };
    const wrap = document.getElementById('chart-wrap');
    const historyBlock = document.getElementById('history-block');
    const historyPeriodLabel = document.getElementById('history-period-label');
    const historyList = document.getElementById('history-list');
    const stateLoading = document.getElementById('chart-state-loading');
    const stateEmpty = document.getElementById('chart-state-empty');
    const stateError = document.getElementById('chart-state-error');
    const container = document.getElementById('chart-container');
    const canvas = document.getElementById('portfolio-chart');

    let chart = null;
    let currentPeriod = { minutes: 10 };

    /**
     * Formats number as USDT amount (2 decimal places).
     * @param {number|null|undefined} n
     * @returns {string}
     */
    function formatUsdt(n) {
        if (n == null || Number.isNaN(n)) { return '—'; }
        return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n) + ' USDT';
    }

    /**
     * Formats number as percent with sign (+/-) and two decimal places.
     * @param {number|null|undefined} n
     * @returns {string}
     */
    function formatPercent(n) {
        if (n == null || Number.isNaN(n)) { return '—'; }
        const s = n >= 0 ? '+' + n.toFixed(2) : n.toFixed(2);
        return s + '%';
    }

    /**
     * Sets card class for change color (positive/negative).
     * @param {HTMLElement} el element with class card__value
     * @param {boolean|null|undefined} positive true — green, false — red
     */
    function setCardClass(el, positive) {
        el.classList.remove('card__value--positive', 'card__value--negative');
        if (positive === true) { el.classList.add('card__value--positive'); }
        if (positive === false) { el.classList.add('card__value--negative'); }
    }

    /**
     * Shows one of chart state blocks (loading / empty / error / chart), hides the rest.
     * @param {string} id element id to show (chart-state-loading, chart-state-empty, chart-state-error, chart-container)
     */
    function showState(id) {
        [stateLoading, stateEmpty, stateError, container].forEach(function (el) {
            el.classList.add('hidden');
        });
        const show = document.getElementById(id);
        if (show) { show.classList.remove('hidden'); }
    }

    /**
     * Fetches portfolio history from API for the selected period, updates cards, chart and history list.
     * @param {Object} period either { minutes: N } or { hours: N }
     * @param {boolean} [skipCache] if true appends _=timestamp to URL to bypass cache (e.g. after Mercure)
     */
    function load(period, skipCache) {
        currentPeriod = period;
        showState('chart-state-loading');
        const base = API_URL + (period.minutes != null ? '?minutes=' + encodeURIComponent(period.minutes) : '?hours=' + encodeURIComponent(period.hours));
        const url = skipCache ? base + '&_=' + Date.now() : base;

        fetch(url)
            .then(function (r) {
                if (!r.ok) { throw new Error('Load error: ' + r.status); }
                return r.json();
            })
            .then(function (data) {
                if (!Array.isArray(data) || data.length === 0) {
                    cards.last.textContent = '—';
                    cards.change.textContent = '—';
                    showState('chart-state-empty');
                    if (chart) { chart.destroy(); chart = null; }
                    if (historyBlock && historyList) {
                        historyBlock.classList.remove('hidden');
                        historyPeriodLabel.textContent = periodLabel(currentPeriod);
                        historyList.innerHTML = '<li class="history-item history-item--empty">No data for the selected period.</li>';
                        historyList.classList.remove('hidden');
                    }
                    return;
                }
                const last = data[data.length - 1].amount_usdt;
                const first = data[0].amount_usdt;
                const changePct = first && first !== 0 ? ((last - first) / first) * 100 : null;
                cards.last.textContent = formatUsdt(last);
                cards.change.textContent = formatPercent(changePct);
                setCardClass(cards.change, changePct != null && changePct >= 0);

                const labels = data.map(function (d) {
                    const t = new Date(d.time);
                    return t.toLocaleDateString('en-US', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                });
                const values = data.map(function (d) { return d.amount_usdt; });

                showState('chart-container');
                const style = getComputedStyle(document.documentElement);
                const gridColor = style.getPropertyValue('--chart-grid').trim() || '#2d3a4d';
                const lineColor = style.getPropertyValue('--chart-line').trim() || '#3fb950';
                const textMuted = style.getPropertyValue('--text-muted').trim() || '#8b9cb3';

                if (chart) { chart.destroy(); }
                chart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'USDT',
                            data: values,
                            borderColor: lineColor,
                            backgroundColor: lineColor + '20',
                            fill: true,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: gridColor },
                                ticks: { color: textMuted, maxTicksLimit: 10 }
                            },
                            y: {
                                grid: { color: gridColor },
                                ticks: { color: textMuted }
                            }
                        }
                    }
                });

                if (historyBlock && historyList && historyPeriodLabel) {
                    historyBlock.classList.remove('hidden');
                    historyPeriodLabel.textContent = periodLabel(currentPeriod);
                    historyList.innerHTML = data.slice().reverse().map(function (d) {
                        const t = new Date(d.time);
                        const timeStr = t.toLocaleString('en-US', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        return '<li class="history-item"><span class="history-item__time">' + escapeHtml(timeStr) + '</span> <span class="history-item__value">' + formatUsdt(d.amount_usdt) + '</span></li>';
                    }).join('');
                    historyList.classList.remove('hidden');
                }
            })
            .catch(function (err) {
                cards.last.textContent = '—';
                cards.change.textContent = '—';
                stateError.textContent = err.message || 'Error loading data.';
                showState('chart-state-error');
                if (chart) { chart.destroy(); chart = null; }
                if (historyBlock && historyList) {
                    historyBlock.classList.remove('hidden');
                    if (historyPeriodLabel) { historyPeriodLabel.textContent = periodLabel(currentPeriod); }
                    historyList.innerHTML = '<li class="history-item history-item--error">Load error.</li>';
                    historyList.classList.remove('hidden');
                }
            });
    }

    /**
     * Returns period label for UI («10 min», «1 h», «24 h», etc.).
     * @param {Object} period object with minutes or hours
     * @returns {string}
     */
    function periodLabel(period) {
        if (period.minutes != null) { return period.minutes === 10 ? '10 min' : period.minutes + ' min'; }
        if (period.hours === 1) { return '1 h'; }
        if (period.hours === 24) { return '24 h'; }
        return period.hours + ' h';
    }

    /**
     * Reads period from current URL query (minutes or hours). Used on page load and popstate.
     * @returns { { minutes: number } | { hours: number } | null } period or null if params missing/invalid
     */
    function getPeriodFromUrl() {
        const p = new URLSearchParams(window.location.search);
        const m = p.get('minutes');
        const h = p.get('hours');
        if (m !== null && m !== '') { const n = parseInt(m, 10); if (n >= 1 && n <= 1440) { return { minutes: n }; } }
        if (h !== null && h !== '') { const n = parseInt(h, 10); if (n >= 1 && n <= 24) { return { hours: n }; } }
        return null;
    }

    /**
     * Writes selected period to URL (minutes or hours) via pushState, no page reload.
     * @param {Object} period object with minutes or hours
     */
    function setPeriodInUrl(period) {
        const url = new URL(window.location.href);
        url.searchParams.delete('minutes');
        url.searchParams.delete('hours');
        if (period.minutes != null) { url.searchParams.set('minutes', String(period.minutes)); }
        else { url.searchParams.set('hours', String(period.hours)); }
        window.history.pushState({}, '', url.toString());
    }

    /**
     * Highlights active period button by data-minutes/data-hours to match current period.
     * @param {Object} period object with minutes or hours
     */
    function setActiveButtonForPeriod(period) {
        document.querySelectorAll('.period-selector button').forEach(function (b) {
            const m = b.getAttribute('data-minutes');
            const h = b.getAttribute('data-hours');
            const match = (period.minutes != null && m !== null && m !== '' && parseInt(m, 10) === period.minutes) ||
                (period.hours != null && h !== null && h !== '' && parseInt(h, 10) === period.hours);
            b.classList.toggle('active', !!match);
            b.setAttribute('aria-selected', match ? 'true' : 'false');
        });
    }

    /**
     * Applies selected period: updates currentPeriod, buttons, label and triggers data load (one API request).
     * Called on page load, period button click and popstate.
     * @param {Object} period object with minutes or hours
     */
    function applyPeriod(period) {
        currentPeriod = period;
        setActiveButtonForPeriod(period);
        if (historyPeriodLabel) { historyPeriodLabel.textContent = periodLabel(period); }
        load(period);
    }

    document.querySelectorAll('.period-selector button').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const m = this.getAttribute('data-minutes');
            const h = this.getAttribute('data-hours');
            const period = (m !== null && m !== '') ? { minutes: parseInt(m, 10) } : { hours: parseInt(h, 10) };
            setPeriodInUrl(period);
            applyPeriod(period);
        });
    });

    window.addEventListener('popstate', function () {
        const period = getPeriodFromUrl();
        if (period) { applyPeriod(period); }
    });

    /**
     * Shows toast notification for 4 seconds.
     * @param {string} text message text
     */
    function showToast(text) {
        const toast = document.getElementById('toast');
        if (!toast) { return; }
        toast.textContent = text;
        toast.classList.remove('hidden');
        setTimeout(function () { toast.classList.add('hidden'); }, 4000);
    }

    const mercureStateEl = document.getElementById('mercure-state');
    /**
     * Updates Mercure status indicator (ON/OFF and highlight class).
     * @param {boolean} on true — connected, false — disconnected/error
     */
    function setMercureState(on) {
        if (!mercureStateEl) { return; }
        mercureStateEl.textContent = on ? 'ON' : 'OFF';
        mercureStateEl.classList.remove('mercure-status__state--on', 'mercure-status__state--off');
        mercureStateEl.classList.add(on ? 'mercure-status__state--on' : 'mercure-status__state--off');
    }
    let mercureEventSource = null;
    if (MERCURE_SUBSCRIBE_URL) {
        try {
            setMercureState(false);
            mercureEventSource = new EventSource(MERCURE_SUBSCRIBE_URL);
            mercureEventSource.onopen = function () {
                setMercureState(true);
            };
            mercureEventSource.onmessage = function (e) {
                let payload = null;
                try { payload = e.data ? JSON.parse(e.data) : null; } catch (err) {}
                if (payload && typeof payload.amount_usdt === 'number' && cards.last) {
                    cards.last.textContent = formatUsdt(payload.amount_usdt);
                }
                showToast('New portfolio data');
                load(currentPeriod, true);
            };
            mercureEventSource.onerror = function () {
                setMercureState(false);
            };
            window.addEventListener('beforeunload', function () {
                if (mercureEventSource) { mercureEventSource.close(); }
            });
        } catch (err) {
            setMercureState(false);
        }
    } else {
        setMercureState(false);
    }

    /**
     * Escapes string for safe HTML insertion (XSS protection when rendering history list).
     * @param {string} s
     * @returns {string}
     */
    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    applyPeriod(getPeriodFromUrl() || { minutes: 10 });
})();
</script>
{% endblock %}
